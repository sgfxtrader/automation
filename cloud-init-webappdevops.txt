#cloud-config
package_upgrade: true
packages:
  - default-jdk
  - nginx
write_files:
  - owner: www-data:www-data
  - path: /etc/nginx/sites-available/default
    content: |
      server {
        listen 443 ssl;
        ssl_certificate /etc/nginx/ssl/sgfxcert.cert;
        ssl_certificate_key /etc/nginx/ssl/sgfxcert.prv;
      
        # Load balance requests for /tomcat-app/ across Tomcat application servers  
        location /tomcat-app/ {  
          proxy_pass http://tomcat;  
          proxy_cache backcache;  
        }

        # Return a temporary redirect to the /tomcat-app/ directory  
        # when user requests '/'  
        location = / { 
            return 302 /tomcat-app/;  
        }
      }     
runcmd:
  - secretName=$(find /var/lib/waagent/ -name "*.prv" | cut -c -57)
  - mkdir /etc/nginx/ssl
  - cp $secretName.crt /etc/nginx/ssl/sgfxcert.cert
  - cp $secretName.prv /etc/nginx/ssl/sgfxcert.prv
  - mkdir /opt/tomcat
  - groupadd -g 200 tomcat
  - useradd -u 201 -g 200 tomcat -s /bin/false -d /opt/tomcat
  - cd /tmp
  - wget https://raw.githubusercontent.com/sgfxtrader/automation/azureCustomScript/tomcat-users.xml
  - wget http://updates.jenkins-ci.org/download/war/2.176/jenkins.war
  - wget http://www-us.apache.org/dist/tomcat/tomcat-9/v9.0.19/bin/apache-tomcat-9.0.19.tar.gz
  - wget https://raw.githubusercontent.com/sgfxtrader/automation/azureCustomScript/context.xml
  - tar xzvf apache-tomcat-9*tar.gz -C /opt/tomcat --strip-components=1
  - rm /opt/tomcat/conf/tomcat-users.xml
  - mv /tmp/tomcat-users.xml /opt/tomcat/conf
  - mv /tmp/jenkins.war /opt/tomcat/webapps
  - mv /tmp/context.xml /opt/tomcat/webapps/manager/META-INF
  - cd /opt/tomcat
  - chgrp -R tomcat /opt/tomcat
  - chmod -R g+r conf
  - chmod g+x conf
  - cd /opt
  - chown -R tomcat tomcat/
  - echo "export CATALINA_HOME="/opt/tomcat"" >> ~/.bashrc
  - echo "export JAVA_HOME="/usr/lib/jvm/java-1.11.0-openjdk-amd64"" >> ~/.bashrc
  - echo "export JRE_HOME="/usr/lib/jvm/java-1.11.0-openjdk-amd64"" >> ~/.bashrc
  - source ~/.bashrc
  - cd /opt/tomcat
  - chmod +x ./bin/startup.sh
  - ./bin/startup.sh
  - service nginx restart
