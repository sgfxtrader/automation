#cloud-config
package_upgrade: true
packages:
  - nginx
  - default-jdk
write_files:
  - owner: www-data:www-data
  - path: /etc/nginx/sites-available/default
    content: |
      server {
        listen 443 ssl;
        ssl_certificate /etc/nginx/ssl/sgfxcert.cert;
        ssl_certificate_key /etc/nginx/ssl/sgfxcert.prv;
      }
runcmd:
  - secretName=$(find /var/lib/waagent/ -name "*.prv" | cut -c -57)
  - mkdir /etc/nginx/ssl
  - cp $secretName.crt /etc/nginx/ssl/sgfxcert.cert
  - cp $secretName.prv /etc/nginx/ssl/sgfxcert.prv
  - service nginx restart
